#!/usr/bin/env python
# Script for handling i3 workspaces with custom, user-entered names. The
# following arguments are accepted:
#    One of:
#      focus - focuses the chosen workspace (default)
#      move - moves focused container to the chosen workspace and focuses it.
#      rename - renames the current workspace.
#  AND
#    One of:
#      menu - pre-populate the dmenu with the names of all existing
#          workspaces (default).
#      freeform - Don't pre-populate dmenu with anything--allow fully
#          custom input lines.
#      auto - Don't use a dmenu at all; instead, pick the next available
#          numeric name.
#      manual:XXX - Don't use a dmenu; instead use XXX as if it were typed
#          at a dmenu.

import sys
import string
import subprocess
import json

# Process arguments.
action = 'focus'
namePicker = 'menu'
for arg in sys.argv[1:]:
  if arg in ['focus', 'move', 'rename']:
    action = arg
  elif arg in ['menu', 'freeform', 'auto']:
    namePicker = arg
  elif arg.startswith('manual:'):
    namePicker = arg
  else:
    raise KeyError 

def parseNumber(workspace):
  """ Tries to parse the workspace number out of a full workspace name. Returns
  -1 iff no number can be found.
  """
  split = string.split(workspace, ':', 1)
  try:
    # Use split[0] regardless of whether there is a split[1].
    return int(split[0])
  except ValueError:
    return -1

# Fetch names used by workspaces.
workspaces = []
focusedWorkspace = ''
focusedWorkspaceNumber = -1
for w in json.loads(
    subprocess.check_output(['i3-msg', '-t', 'get_workspaces'])):
  workspace = w['name']
  if w['focused']:
    focusedWorkspace = workspace
    focusedWorkspaceNumber = parseNumber(workspace)
  workspaces.append(workspace)

# Use this map to look up a good dmenu caption for each action.
captions = {
  'move': 'Move to workspace:',
  'focus': 'Switch to workspace:',
  'rename': 'New workspace name:',
}

# Compute the workspace name.
if namePicker == 'menu' or namePicker == 'freeform':
  # Use dmenu.
  newWorkspace, _ = (subprocess.Popen(['dmenu', '-p', captions[action]],
      stdin= subprocess.PIPE, stdout= subprocess.PIPE)
      .communicate('\n'.join(workspaces)))
  newWorkspace = newWorkspace.strip()
  
elif namePicker == 'auto':
  # Don't use dmenu; just compute the next available numeric name.
  newWorkspace = 1
  workspaceNumbers = set(map(parseNumber, workspaces))
  while newWorkspace in workspaceNumbers:
    newWorkspace += 1
  newWorkspace = str(newWorkspace)
  
elif namePicker.startswith('manual:'):
  # Strip off the 'manual:' prefix.
  newWorkspace = namePicker[len('manual:'):]
  
# If the user didn't add a numeric prefix, add one for them, keeping the
# same workspace number.
if focusedWorkspaceNumber > 0 and parseNumber(newWorkspace) < 0:
  newWorkspace = "%d:%s" % (focusedWorkspaceNumber, newWorkspace)

if newWorkspace and newWorkspace != focusedWorkspace:
  # Use this map to look up the proper command format string for each action.
  i3Commands = {
    'move': 'move container to workspace "%(newWorkspace)s"; ' +
        'workspace "%(newWorkspace)s"',
    'focus': 'workspace "%(newWorkspace)s"',
    'rename': 'rename workspace to "%(newWorkspace)s"',
  }

  # Construct a command to send to i3.
  i3Command = i3Commands[action] % {'newWorkspace': newWorkspace}
    
  # Send the command. Suppress stdout, since i3-msg is kinda chatty.
  subprocess.call(['i3-msg', i3Command], stdout=subprocess.PIPE)
