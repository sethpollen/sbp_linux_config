#!/bin/sh
# Interprets its arg vector as a command to be executed. Returns
# immediately, printing the cached value for this command from a previous
# run and forking an asnychronous computation to update the cached value.

# Snapshot the command and the directory to run it in.
cmd="$@"
cmd_pwd="$PWD"
key=$(filename-safe-escape "${cmd_pwd}" "${cmd}")

if [ "${#key}" -ge 250 ]; then
  # This key is too long for memcache. Truncate it, prepending a hash to
  # ensure uniqueness.
  key="$(echo "$key" | md5hash)${key}"
  key="${key:0:250}"
fi

# Immediately return the cache contents.
read-cache "$key"

# Spawn a child to populate the cache.
populate_cache() {
  write-cache "$key" "$(cd "$cmd_pwd" && $cmd)"
}
fk populate_cache

